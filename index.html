<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meus Livros</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>

    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“š</text></svg>"
    />

    <style>
      :root {
        --bg-color: #14181c;
        --card-bg: #232a31;
        --text-color: #9ab;
        --poster-border: #fff;
        --star-color: #0083e0;
        --highlight: #40bcf4;
        --input-bg: #2c3440;
      }

      body {
        background-color: var(--bg-color);
        color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        overflow-y: scroll;
      }

      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 20px;
        padding-bottom: 60px;
      }

      /* HEADER & STATS */
      header {
        text-align: center;
        margin-bottom: 20px;
      }
      .stats {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        margin-bottom: 30px;
      }
      .stat-box {
        text-align: center;
        cursor: default;
        transition: transform 0.2s;
      }
      .stat-box span {
        font-size: 1.5rem;
        font-weight: bold;
        display: block;
      }
      .stat-box small {
        color: var(--text-color);
        text-transform: uppercase;
        font-size: 0.8rem;
      }

      .stat-box.interactive {
        cursor: pointer;
      }
      .stat-box.interactive:hover {
        transform: scale(1.1);
      }
      .stat-box.interactive span {
        color: var(--highlight);
      }

      /* FILTRO */
      .filter-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #2c3440;
      }
      .active-filter-tag {
        background: var(--highlight);
        color: #000;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
      }
      .active-filter-tag:hover {
        opacity: 0.9;
      }

      .sort-select {
        background-color: var(--input-bg);
        color: #fff;
        border: 1px solid #456;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
      }

      /* GRID */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 25px 15px;
      }
      .card {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .card:hover {
        transform: translateY(-5px);
      }
      .poster {
        width: 100%;
        aspect-ratio: 2 / 3;
        border-radius: 4px;
        border: 1px solid #2c3440;
        background-color: #1e2328;
        overflow: hidden;
        position: relative;
      }
      .poster:hover {
        border-color: var(--poster-border);
      }
      .poster img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .info {
        margin-top: 8px;
        text-align: center;
      }
      .stars {
        color: var(--star-color);
        font-size: 0.9rem;
        letter-spacing: 1px;
      }

      /* MODALS */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 20px;
      }
      .modal-content {
        background: var(--card-bg);
        width: 100%;
        max-width: 800px;
        max-height: 90vh;
        border-radius: 8px;
        display: flex;
        gap: 30px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        overflow-y: auto;
        position: relative;
      }
      .close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 2rem;
        cursor: pointer;
        color: var(--text-color);
        line-height: 1;
        z-index: 10;
      }
      .close-btn:hover {
        color: #fff;
      }

      .modal-poster {
        width: 250px;
        flex-shrink: 0;
      }
      .modal-poster img {
        width: 100%;
        border-radius: 4px;
        border: 1px solid var(--text-color);
      }
      .modal-details {
        flex-grow: 1;
      }
      .modal-details h2 {
        margin-top: 0;
        font-size: 2rem;
        line-height: 1.1;
      }
      .review-box {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #364049;
        line-height: 1.6;
      }

      /* MAPA CONTAINER */
      .map-container {
        width: 100%;
        height: 60vh;
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* PAGINÃ”METRO */
      .paginometer {
        margin-top: 50px;
        padding-top: 20px;
        border-top: 1px solid #2c3440;
        display: flex;
        justify-content: center;
        gap: 40px;
        color: var(--text-color);
      }
      .page-stat {
        text-align: center;
      }
      .page-stat strong {
        display: block;
        font-size: 1.2rem;
        color: #fff;
      }

      @media (max-width: 600px) {
        .modal-content {
          flex-direction: column;
          padding: 20px;
        }
        .modal-poster {
          width: 150px;
          margin: 0 auto;
        }
        .modal-details {
          text-align: center;
        }
        .paginometer {
          gap: 20px;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="container">
      <div
        v-if="showMapModal"
        class="modal-overlay"
        @click.self="showMapModal = false"
      >
        <div class="modal-content" style="display: block; max-width: 900px">
          <span class="close-btn" @click="showMapModal = false">&times;</span>
          <h2 style="text-align: center; margin-bottom: 10px">
            Mapa de Leitura
          </h2>
          <p
            style="
              text-align: center;
              color: var(--text-color);
              margin-bottom: 20px;
            "
          >
            Clique em um paÃ­s para filtrar os livros.
          </p>

          <div class="map-container" id="google_map_div">
            <div v-if="loadingMap" style="color: #ccc">Carregando Mapa...</div>
          </div>
        </div>
      </div>

      <div
        v-if="selectedBook"
        class="modal-overlay"
        @click.self="selectedBook = null"
      >
        <div class="modal-content">
          <span class="close-btn" @click="selectedBook = null">&times;</span>
          <div class="modal-poster">
            <img
              :src="getCover(selectedBook)"
              @error="$event.target.src = generatePlaceholderCover(selectedBook)"
            />
          </div>
          <div class="modal-details">
            <h2>{{ selectedBook.title }}</h2>
            <div class="stars" style="font-size: 1.2rem; margin-bottom: 10px">
              {{ getStars(selectedBook.rate) }}
            </div>
            <div class="modal-meta">
              <span>{{ selectedBook.year }}</span>
              <span>{{ selectedBook.author }}</span>
              <span>{{ selectedBook.country }}</span>
              <span>{{ selectedBook.pages }} pÃ¡g.</span>
            </div>
            <div class="review-box">
              <h3>Minha Resenha</h3>
              <p
                v-if="selectedBook.review"
                style="white-space: pre-wrap"
                v-html="selectedBook.review"
              ></p>
              <div v-else class="review-placeholder">
                Nenhuma resenha escrita.
              </div>
            </div>
          </div>
        </div>
      </div>

      <header>
        <h1>Minha Biblioteca</h1>
        <div class="stats">
          <div class="stat-box">
            <span>{{ totalBooks }}</span><small>Livros</small>
          </div>
          <div class="stat-box">
            <span>{{ uniqueAuthors }}</span><small>Autores</small>
          </div>
          <div
            class="stat-box interactive"
            @click="openMap"
            title="Ver Mapa Mundi"
          >
            <span>{{ uniqueCountries }}</span><small>PaÃ­ses</small>
          </div>
        </div>
      </header>

      <div class="filter-bar">
        <div>
          <div
            v-if="filterCountry"
            class="active-filter-tag"
            @click="filterCountry = null"
          >
            <span>{{ filterCountry }}</span>
            <span style="font-size: 1.2em">&times;</span>
          </div>
        </div>
        <div>
          <span class="sort-label">Ordenar por:</span>
          <select v-model="sortBy" class="sort-select">
            <option value="read_desc">Lidos Recentemente</option>
            <option value="read_asc">Lidos Antigamente</option>
            <option value="rating">Melhores Notas</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <div
          v-for="book in sortedBooks"
          :key="book.title"
          class="card"
          @click="selectedBook = book"
        >
          <div class="poster">
            <img
              :src="getCover(book)"
              loading="lazy"
              @error="$event.target.src = generatePlaceholderCover(book)"
            />
          </div>
          <div class="info">
            <div class="stars">{{ getStars(book.rate) }}</div>
          </div>
        </div>
      </div>

      <footer class="paginometer">
        <div class="page-stat">
          <strong>{{ totalPages.toLocaleString('pt-BR') }}</strong> PÃ¡ginas
          Lidas
        </div>
        <div class="page-stat">
          <strong>{{ averagePages }}</strong> MÃ©dia p/ Livro
        </div>
      </footer>
    </div>

    <script>
      const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

      // Carregar a lib do Google Charts
      google.charts.load("current", {
        packages: ["geochart"],
      });

      createApp({
        setup() {
          const books = ref([]);
          const selectedBook = ref(null);
          const sortBy = ref("read_desc");
          const showMapModal = ref(false);
          const filterCountry = ref(null);
          const loadingMap = ref(false);

          onMounted(() => {
            // 1. Carregar CSV
            Papa.parse("livros_lidos_atualizado.csv", {
              download: true,
              header: true,
              skipEmptyLines: true,
              complete: (results) => {
                books.value = results.data.map((book, index) => ({
                  ...book,
                  original_index: index,
                  pages: Number(book.pages) || 0,
                  country: mapCountryName(book.country),
                }));
              },
            });
          });

          const mapCountryName = (ptName) => {
            if (!ptName) return "";
            const map = {
              EUA: "United States",
              "Reino Unido": "United Kingdom",
              Brasil: "Brazil",
              ColÃ´mbia: "Colombia",
              Alemanha: "Germany",
              RÃºssia: "Russia",
              FranÃ§a: "France",
              Ãustria: "Austria",
              Noruega: "Norway",
              China: "China",
              Israel: "Israel",
              Portugal: "Portugal",
              ItÃ¡lia: "Italy",
              "Roma Antiga": "Italy",
            };
            return map[ptName] || ptName;
          };

          const totalPages = computed(() =>
            books.value.reduce((acc, book) => acc + book.pages, 0)
          );
          const averagePages = computed(() => {
            if (books.value.length === 0) return 0;
            return Math.round(totalPages.value / books.value.length);
          });
          const totalBooks = computed(() => books.value.length);
          const uniqueAuthors = computed(
            () => [...new Set(books.value.map((b) => b.author))].length
          );
          const uniqueCountries = computed(
            () => [...new Set(books.value.map((b) => b.country))].length
          );

          const chartData = computed(() => {
            const counts = {};
            books.value.forEach((book) => {
              const c = book.country;
              if (c) counts[c] = (counts[c] || 0) + 1;
            });
            // Converter para array [PaÃ­s, Quantidade] que o Google Charts pede
            const data = [["Country", "Livros"]];
            for (const [country, count] of Object.entries(counts)) {
              data.push([country, count]);
            }
            return data;
          });

          // Filtro e OrdenaÃ§Ã£o
          const sortedBooks = computed(() => {
            let list = [...books.value];
            if (filterCountry.value) {
              list = list.filter((b) => b.country === filterCountry.value);
            }
            return list.sort((a, b) => {
              if (sortBy.value === "read_desc") {
                const diff = Number(b.read_in) - Number(a.read_in);
                return diff === 0 ? b.original_index - a.original_index : diff;
              }
              if (sortBy.value === "read_asc") {
                const diff = Number(a.read_in) - Number(b.read_in);
                return diff === 0 ? a.original_index - b.original_index : diff;
              }
              if (sortBy.value === "rating") {
                const diff = (Number(b.rate) || 0) - (Number(a.rate) || 0);
                return diff === 0 ? b.original_index - a.original_index : diff;
              }
              return 0;
            });
          });

          // --- LÃ³gica do Mapa Google Charts ---
          const openMap = () => {
            showMapModal.value = true;
            loadingMap.value = true;

            // Espera o Google carregar a lib e o Modal abrir no DOM
            google.charts.setOnLoadCallback(() => {
              nextTick(() => {
                drawRegionsMap();
                loadingMap.value = false;
              });
            });
          };

          const drawRegionsMap = () => {
            const data = google.visualization.arrayToDataTable(chartData.value);

            const options = {
              backgroundColor: "#232a31", // Fundo do modal
              datalessRegionColor: "#2c3440", // PaÃ­ses sem livros (Cinza escuro)
              colorAxis: { colors: ["#40bcf4", "#0083e0"] }, // Gradiente de Azul
              legend: "none", // Esconder legenda
              tooltip: {
                textStyle: { color: "#000" },
                showColorCode: true,
              },
              // Estilo da borda
              defaultColor: "#2c3440",
            };

            const chart = new google.visualization.GeoChart(
              document.getElementById("google_map_div")
            );

            // Adiciona evento de clique
            google.visualization.events.addListener(chart, "select", () => {
              const selection = chart.getSelection();
              if (selection.length > 0) {
                const countryName = data.getValue(selection[0].row, 0);
                filterCountry.value = countryName;
                showMapModal.value = false; // Fecha modal ao selecionar
              }
            });

            chart.draw(data, options);
          };

          // Helpers
          const generatePlaceholderCover = (book) => {
            const text = encodeURIComponent(book.title);
            return `https://ui-avatars.com/api/?name=${text}&size=300&background=2c3440&color=9ab&bold=true&font-size=0.4`;
          };

          const getCover = (book) => {
            if (book.cover_url?.trim()) return book.cover_url;
            if (book.isbn) {
              const clean = book.isbn.replace(".0", "").trim();
              if (clean)
                return `https://covers.openlibrary.org/b/isbn/${clean}-L.jpg`;
            }
            return generatePlaceholderCover(book);
          };

          const getStars = (rate) => {
            if (!rate) return "";
            const r = parseFloat(rate);
            return "â˜…".repeat(Math.floor(r)) + (r % 1 !== 0 ? "Â½" : "");
          };

          return {
            books,
            sortedBooks,
            sortBy,
            selectedBook,
            showMapModal,
            totalBooks,
            uniqueAuthors,
            uniqueCountries,
            totalPages,
            averagePages,
            filterCountry,
            loadingMap,
            getStars,
            getCover,
            generatePlaceholderCover,
            openMap,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>

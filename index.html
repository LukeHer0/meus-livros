<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Livros</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --bg-color: #14181c;
            --card-bg: #232a31;
            --text-color: #9ab;
            --poster-border: #fff;
            --star-color: #0083e0;
            --highlight: #40bcf4;
            --input-bg: #2c3440;
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            overflow-y: scroll; 
        }

        .container { max-width: 960px; margin: 0 auto; padding: 20px; }
        
        header { text-align: center; margin-bottom: 20px; }
        
        .stats { display: flex; justify-content: center; gap: 30px; margin-top: 20px; margin-bottom: 30px;}
        .stat-box { text-align: center; }
        .stat-box span { font-size: 1.5rem; font-weight: bold; display: block; }
        .stat-box small { color: var(--text-color); text-transform: uppercase; font-size: 0.8rem; }

        .filter-bar {
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2c3440;
        }

        .sort-label {
            color: var(--text-color);
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .sort-select {
            background-color: var(--input-bg);
            color: #fff;
            border: 1px solid #456;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: inherit;
            cursor: pointer;
        }
        
        .sort-select:focus { outline: none; border-color: var(--highlight); }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 25px 15px;
        }

        .card {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .card:hover { transform: translateY(-5px); }

        .poster {
            width: 100%;
            aspect-ratio: 2 / 3;
            border-radius: 4px;
            border: 1px solid #2c3440;
            overflow: hidden;
            position: relative;
        }

        .poster:hover { border-color: var(--poster-border); }
        .poster img { width: 100%; height: 100%; object-fit: cover; }

        .info { margin-top: 8px; text-align: center; }
        .stars { color: var(--star-color); font-size: 0.9rem; letter-spacing: 1px; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 8px;
            display: flex;
            gap: 30px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px; right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-color);
            line-height: 1;
        }
        .close-btn:hover { color: #fff; }

        .modal-poster { width: 250px; flex-shrink: 0; }
        .modal-poster img { width: 100%; border-radius: 4px; border: 1px solid var(--text-color); }

        .modal-details { flex-grow: 1; }
        .modal-details h2 { margin-top: 0; font-size: 2rem; line-height: 1.1; }
        .modal-meta { color: var(--text-color); margin: 10px 0 20px 0; font-size: 0.9rem; }
        .modal-meta span { margin-right: 15px; }
        
        .review-box {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #364049;
            line-height: 1.6;
        }
        .review-placeholder { color: var(--text-color); font-style: italic; }

        @media (max-width: 600px) {
            .modal-content { flex-direction: column; padding: 20px; }
            .modal-poster { width: 150px; margin: 0 auto; }
            .modal-details { text-align: center; }
            .review-box { text-align: left; }
            .filter-bar { justify-content: center; }
        }
    </style>
</head>
<body>

    <div id="app" class="container">
        
        <div v-if="selectedBook" class="modal-overlay" @click.self="selectedBook = null">
            <div class="modal-content">
                <span class="close-btn" @click="selectedBook = null">&times;</span>
                
                <div class="modal-poster">
                    <img :src="getCover(selectedBook)" />
                </div>
                
                <div class="modal-details">
                    <h2>{{ selectedBook.title }}</h2>
                    <div class="stars" style="font-size: 1.2rem; margin-bottom: 10px;">
                        {{ getStars(selectedBook.rate) }}
                    </div>
                    
                    <div class="modal-meta">
                        <span>{{ selectedBook.year }}</span>
                        <span>{{ selectedBook.author }}</span>
                        <span>{{ selectedBook.pages }} pág.</span>
                        <span v-if="selectedBook.genre" style="color: var(--highlight)">{{ selectedBook.genre }}</span>
                    </div>

                    <div class="review-box">
                        <h3>Minha Resenha</h3>
                        <div v-if="selectedBook.review">
                            <p style="white-space: pre-wrap;">{{ selectedBook.review }}</p>
                        </div>
                        <div v-else class="review-placeholder">
                            Nenhuma resenha escrita para este livro ainda.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <header>
            <h1>Minha Biblioteca</h1>
            <div class="stats">
                <div class="stat-box"><span>{{ totalBooks }}</span><small>Livros</small></div>
                <div class="stat-box"><span>{{ uniqueAuthors }}</span><small>Autores</small></div>
                <div class="stat-box"><span>{{ uniqueCountries }}</span><small>Países</small></div>
            </div>
        </header>

        <div class="filter-bar">
            <span class="sort-label">Ordenar por:</span>
            <select v-model="sortBy" class="sort-select">
                <option value="read_desc">Lidos Recentemente</option>
                <option value="read_asc">Lidos Antigamente</option>
                <option value="year_desc">Ano de Publicação (Novo → Velho)</option>
                <option value="year_asc">Ano de Publicação (Velho → Novo)</option>
                <option value="rating">Melhores Notas</option>
                <option value="alpha">Ordem Alfabética</option>
            </select>
        </div>

        <div class="grid">
            <div v-for="(book, index) in sortedBooks" :key="index" class="card" @click="selectedBook = book">
                <div class="poster">
                    <img :src="getCover(book)" loading="lazy" />
                </div>
                <div class="info">
                    <div class="stars">{{ getStars(book.rate) }}</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const books = ref([]);
                const selectedBook = ref(null);
                const sortBy = ref('read_desc');

                onMounted(() => {
                    Papa.parse('livros_lidos_atualizado.csv', {
                        download: true,
                        header: true,
                        skipEmptyLines: true, 
                        complete: (results) => {
                            books.value = results.data;
                        }
                    });
                });

                const sortedBooks = computed(() => {
                    let list = [...books.value];

                    return list.sort((a, b) => {
                        if (sortBy.value === 'alpha') {
                            return a.title.localeCompare(b.title);
                        } 
                        else if (sortBy.value === 'read_desc') {
                            return Number(b.read_in) - Number(a.read_in);
                        }
                        else if (sortBy.value === 'read_asc') {
                            return Number(a.read_in) - Number(b.read_in);
                        }
                        else if (sortBy.value === 'year_desc') {
                            return Number(b.year) - Number(a.year);
                        }
                        else if (sortBy.value === 'year_asc') {
                            return Number(a.year) - Number(b.year);
                        }
                        else if (sortBy.value === 'rating') {
                            return (Number(b.rate) || 0) - (Number(a.rate) || 0);
                        }
                        return 0;
                    });
                });

                const totalBooks = computed(() => books.value.length);
                const uniqueAuthors = computed(() => [...new Set(books.value.map(b => b.author))].length);
                const uniqueCountries = computed(() => [...new Set(books.value.map(b => b.country))].length);

                const getCover = (book) => {
                    if (book.cover_url && book.cover_url.trim() !== '') {
                        return book.cover_url;
                    }
                    const cleanIsbn = book.isbn ? book.isbn.replace('.0', '') : '';
                    if (cleanIsbn) {
                        return `https://covers.openlibrary.org/b/isbn/${cleanIsbn}-L.jpg`;
                    }
                    return 'https://via.placeholder.com/128x192?text=Sem+Capa';
                };

                const getStars = (rate) => {
                    if (!rate) return '';
                    const r = parseFloat(rate);
                    return '★'.repeat(Math.floor(r)) + (r % 1 !== 0 ? '½' : '');
                };

                return { 
                    books, 
                    sortedBooks,
                    sortBy,   
                    selectedBook, 
                    totalBooks, 
                    uniqueAuthors, 
                    uniqueCountries, 
                    getCover, 
                    getStars 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>